---
name: design
description: 方案设计阶段详细规则；进入方案设计时读取；包含方案生成、任务拆分、方案包创建
---

# 方案设计 - 详细规则

**目标：** 设计技术方案，拆分可执行任务，创建方案包

**执行流程：**
```
1. 确定方案包级别 (light/standard/full)
2. 生成方案文件
3. 拆分任务清单
4. 输出摘要
```

---

## 步骤 1: 确定方案包级别

**自动判定逻辑 (plan.level=auto)：**

```yaml
light (单文件 plan.md):
  - 文件数 3-5
  - 无架构变更
  - 修改范围明确

standard (三文件):
  - 文件数 > 5
  - 或 新功能开发
  - 或 跨模块修改

full (完整结构):
  - 架构级变更
  - 重大重构
  - 新系统设计
```

---

## 步骤 2: 生成方案文件

### Light 级别 - plan.md

```markdown
# {功能名称}

## 背景
{1-2 句话描述需求背景}

## 方案
{技术方案要点，列表形式}

## 任务
- [ ] {任务1}
- [ ] {任务2}
- [ ] {任务3}

## 变更文件
- {file1}
- {file2}
```

### Standard 级别 - 三文件结构

**background.md:**
```markdown
# 变更提案: {功能名称}

## 需求背景
{描述现状、痛点及变更驱动因素}

## 变更内容
1. {变更点1}
2. {变更点2}

## 影响范围
- 模块: {列表}
- 文件: {列表}

## 风险评估
- 风险: {描述}
- 缓解: {措施}
```

**design.md:**
```markdown
# 技术设计: {功能名称}

## 技术方案
- 核心技术: {语言/框架/库}
- 实现要点:
  - {要点1}
  - {要点2}

## 架构设计
{如有变更，包含 mermaid 图}

## 安全与性能
- 安全: {措施}
- 性能: {优化}
```

**tasks.md:**
```markdown
# 任务清单: {功能名称}

目录: `.sopify-skills/plan/YYYYMMDD_{feature}/`

## 1. {模块名称}
- [ ] 1.1 在 `{文件路径}` 中实现 {功能}
- [ ] 1.2 在 `{文件路径}` 中实现 {功能}

## 2. 测试
- [ ] 2.1 {测试任务}

## 3. 文档更新
- [ ] 3.1 更新 {知识库文件}
```

### Full 级别 - 完整结构

在 Standard 基础上增加：

```
.sopify-skills/plan/YYYYMMDD_feature/
├── background.md
├── design.md
├── tasks.md
├── adr/
│   └── 001-{决策标题}.md
└── diagrams/
    └── {图表名}.mermaid
```

**adr/001-xxx.md:**
```markdown
# ADR-001: {决策标题}

## 状态
已采纳 | 待定 | 已废弃

## 上下文
{背景和问题}

## 决策
{核心决策}

## 理由
{原因}

## 替代方案
- {方案A}: 拒绝原因 - {原因}

## 影响
{后果与风险}
```

---

## 步骤 3: 任务拆分原则

**任务粒度：**
```yaml
每个任务应该:
  - 可在 30 分钟内完成
  - 有明确的验证标准
  - 依赖关系清晰

任务分类:
  1. 核心功能实现
  2. 辅助功能
  3. 安全检查
  4. 测试
  5. 文档更新
```

**任务状态符号：**
| 符号 | 含义 |
|-----|------|
| `[ ]` | 待执行 |
| `[x]` | 已完成 |
| `[-]` | 已跳过 |
| `[!]` | 阻塞中 |

---

## 步骤 4: 输出格式

```
[{BRAND_NAME}] 方案设计 ✓

方案: .sopify-skills/plan/{YYYYMMDD}_{feature}/
概要: {一句话技术方案}
任务: {N} 项

---
Changes: {N} files
  - .sopify-skills/plan/...

Next: ~go exec 执行 或 回复修改意见
```

---

## 阶段转换规则

```yaml
workflow.mode = strict:
  → 输出摘要 → 等待用户确认

workflow.mode = adaptive:
  → 如果是 ~go 命令触发 → 自动进入开发实施
  → 如果是 ~go plan 命令触发 → 输出摘要并停止

用户回复修改意见:
  → 保持在方案设计阶段 → 更新方案文件 → 重新输出摘要
```

---

## 方案包命名规则

```
格式: YYYYMMDD_feature_name
示例: 20260115_user_auth
      20260115_fix_login_bug
      20260115_refactor_api
```

**命名原则：**
- 使用下划线分隔
- 功能名用英文小写
- 简洁但能识别功能
