---
name: analyze
description: 需求分析阶段详细规则；进入需求分析时读取；包含需求评分、追问逻辑、代码分析步骤
---

# 需求分析 - 详细规则

**目标：** 验证需求完整性，分析代码现状，为方案设计提供基础

**执行流程：**
```
Phase A (步骤 1-4) → 关键检查点: 评分 ≥ require_score?
  ├─ 是 → 执行 Phase B (步骤 5-6) → 输出摘要
  └─ 否 → 检查 auto_decide
       ├─ true → AI 自行判断，继续执行
       └─ false → 输出追问 → 等待用户补充
```

---

## Phase A: 需求评估

### 步骤 1: 检查知识库状态

```yaml
判定条件: 工作目录存在代码文件 且 需求不是"新项目"
执行方式: 检查 .sopify/ 目录是否存在
问题标记: 如知识库不存在，标记需要初始化
```

### 步骤 2: 获取项目上下文

```yaml
执行方式: 读取知识库 → 不足则扫描代码
详细规则: 参考 kb Skill
目的: 为评分和追问提供完整项目上下文
```

### 步骤 3: 需求类型判定

- 新项目初始化
- 新功能开发
- 功能修改/增强
- Bug 修复
- 重构优化
- 技术变更

### 步骤 4: 需求完整性评分

**评分维度 (总分 10 分)：**

| 维度 | 分值 | 说明 |
|-----|------|------|
| 目标清晰 | 0-3 | 任务目标是否明确具体 |
| 预期结果 | 0-3 | 成功标准和交付物是否清晰 |
| 边界范围 | 0-2 | 任务范围和边界是否明确 |
| 约束条件 | 0-2 | 时间、性能、业务约束是否说明 |

**评分推理过程 (在 <thinking> 中完成)：**

```
<thinking>
1. 逐项分析评分维度:
   - 目标清晰 (0-3): [分析] → X 分
   - 预期结果 (0-3): [分析] → X 分
   - 边界范围 (0-2): [分析] → X 分
   - 约束条件 (0-2): [分析] → X 分
2. 列举支持评分的具体证据
3. 识别缺失的关键信息
4. 计算总分: X/10
5. 判定: [是否需要追问及原因]
</thinking>
```

**评分后处理：**

```yaml
评分 ≥ require_score: 继续执行 Phase B

评分 < require_score:
  auto_decide = true: AI 自行补充假设，继续执行
  auto_decide = false: 输出追问，等待回复
```

### 追问输出格式

```
[{BRAND_NAME}] 需求分析 ?

当前评分 {X}/10，需要补充以下信息:

1. {问题1}
2. {问题2}
3. {问题3}

---
Next: 请回答问题，或输入 "继续" 跳过追问
```

**追问规则：**
- 不问已知信息 (技术栈、框架等可从代码获取)
- 只问用户相关信息 (具体需求、业务逻辑、预期)
- 问题数量: 3-5 个

---

## Phase B: 代码分析 (评分达标后执行)

### 步骤 5: 提取关键目标

- 从完整需求中提炼核心目标
- 定义可验证的成功标准

### 步骤 6: 代码分析与技术准备

```yaml
执行内容:
  - 确定项目规模
  - 定位相关模块
  - 质量检查: 标记过时信息，扫描安全风险
  - 技术信息收集 (如需要): 使用 web 搜索获取最新文档

交付物: 项目上下文信息，供方案设计使用
```

---

## 输出格式

**评分达标时：**

```
[{BRAND_NAME}] 需求分析 ✓

需求: {一句话描述}
类型: {需求类型}
评分: {X}/10
范围: {预估文件数}

---
Changes: 0 files

Next: 继续方案设计？(Y/n)
```

**adaptive 模式下的路由判定：**

```yaml
简单任务 (≤2 文件, 明确需求):
  → 跳过方案设计，直接进入快速修复

中等任务 (3-5 文件):
  → 进入轻量迭代，生成 light 方案包

复杂任务 (>5 文件 或 架构变更):
  → 进入完整方案设计
```

---

## 阶段转换规则

```yaml
评分 < require_score 且 auto_decide=false:
  → 循环追问直到评分达标或用户取消

评分达标 且 workflow.mode=strict:
  → 输出摘要 → 等待确认

评分达标 且 workflow.mode=adaptive:
  → 根据复杂度判定路由 → 自动进入下一阶段

用户输入 "取消":
  → 输出取消格式，结束流程
```
